// Copyright 2010 Mike Brevoort http://mike.brevoort.com @mbrevoort
// 
// v5.0 jquery-facebook-multi-friend-selector
// 
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
// 
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
(function(e){var t=function(t,n){var r=e(t),i=this,s=[],o,u=0,a=0,f;var l=e.extend({access_token:null,max_selected:-1,max_selected_message:"{0} of {1} selected",pre_selected_friends:[],exclude_friends:[],friend_fields:"id,name",sorter:function(e,t){var n=e.name.toLowerCase();var r=t.name.toLowerCase();return n<r?-1:n>r?1:0},labels:{selected:"Selected",filter_default:"Start typing a name",filter_title:"Find Friends:",all:"All",max_selected_message:"{0} of {1} selected"}},n||{});var c;var h=function(e){var t={};for(var n=0,r=e.length;n<r;n++){t[e[n]]=""}return t};r.html("<div id='jfmfs-friend-selector'>"+"    <div id='jfmfs-inner-header'>"+"        <span class='jfmfs-title'>"+l.labels.filter_title+" </span><input type='text' id='jfmfs-friend-filter-text' value='"+l.labels.filter_default+"'/>"+"        <a class='filter-link selected' id='jfmfs-filter-all' href='#'>"+l.labels.all+"</a>"+"        <a class='filter-link' id='jfmfs-filter-selected' href='#'>"+l.labels.selected+" (<span id='jfmfs-selected-count'>0</span>)</a>"+(l.max_selected>0?"<div id='jfmfs-max-selected-wrapper'></div>":"")+"    </div>"+"    <div id='jfmfs-friend-container'></div>"+"</div>");var p=e("#jfmfs-friend-container"),d=e("#jfmfs-friend-selector"),v=h(l.pre_selected_friends),m=h(l.exclude_friends),g,y;if(l.access_token===null)y="/me/friends?&fields="+l.friend_fields;else y="/me/friends?access_token="+l.access_token+"&fields="+l.friend_fields;FB.api(y,function(t){var n=t.data.sort(l.sorter),i={},o=[],u="";e.each(n,function(e,t){if(!(t.id in m)){u=t.id in v?"selected":"";o.push("<div class='jfmfs-friend "+u+" ' id='"+t.id+"'><img/><div class='friend-name'>"+t.name+"</div></div>")}});p.append(o.join(""));s=e(".jfmfs-friend",r);s.bind("inview",function(t,n){if(e(this).attr("src")===undefined){e("img",e(this)).attr("src","//graph.facebook.com/"+this.id+"/picture")}e(this).unbind("inview")});b()});this.getSelectedIds=function(){var t=[];e.each(r.find(".jfmfs-friend.selected"),function(n,r){t.push(e(r).attr("id"))});return t};this.getSelectedIdsAndNames=function(){var t=[];e.each(r.find(".jfmfs-friend.selected"),function(n,r){t.push({id:e(r).attr("id"),name:e(r).find(".friend-name").text()})});return t};this.clearSelected=function(){g.removeClass("selected")};var b=function(){g=e(".jfmfs-friend",r);f=g.first().offset().top;for(var t=0,n=g.length;t<n;t++){if(e(g[t]).offset().top===f){u++}else{a=e(g[t]).offset().top-f;break}}r.delegate(".jfmfs-friend","click",function(t){var n=l.max_selected===1,s=e(this).hasClass("selected"),o=e(".jfmfs-friend.selected").length>=l.max_selected,u=p.find(".selected").attr("id")===e(this).attr("id");if(!n&&!s&&E()&&o)return;if(n&&!u){p.find(".selected").removeClass("selected")}e(this).toggleClass("selected");e(this).removeClass("hover");if(e(this).hasClass("selected")){if(!c){c=e(this)}else{if(t.shiftKey){var a=e(this).index(),f=c.index(),h=Math.max(a,f),d=Math.min(a,f);for(var m=d;m<=h;m++){var y=e(g[m]);if(!y.hasClass("hide-non-selected")&&!y.hasClass("hide-filtered")){if(E()&&e(".jfmfs-friend.selected").length<l.max_selected){e(g[m]).addClass("selected")}}}}}}c=e(this);v();if(E()){S()}r.trigger("jfmfs.selection.changed",[i.getSelectedIdsAndNames()])});e("#jfmfs-filter-selected").click(function(t){t.preventDefault();g.not(".selected").addClass("hide-non-selected");e(".filter-link").removeClass("selected");e(this).addClass("selected")});e("#jfmfs-filter-all").click(function(t){t.preventDefault();g.removeClass("hide-non-selected");e(".filter-link").removeClass("selected");e(this).addClass("selected")});r.find(".jfmfs-friend:not(.selected)").live("hover",function(t){if(t.type=="mouseover"){e(this).addClass("hover")}if(t.type=="mouseout"){e(this).removeClass("hover")}});r.find("#jfmfs-friend-filter-text").keyup(function(){var t=e(this).val();clearTimeout(o);o=setTimeout(function(){if(t==""){g.removeClass("hide-filtered")}else{d.find(".friend-name:not(:Contains("+t+"))").parent().addClass("hide-filtered");d.find(".friend-name:Contains("+t+")").parent().removeClass("hide-filtered")}h()},400)}).focus(function(){if(e.trim(e(this).val())=="Start typing a name"){e(this).val("")}}).blur(function(){if(e.trim(e(this).val())==""){e(this).val("Start typing a name")}});r.find(".jfmfs-button").hover(function(){e(this).addClass("jfmfs-button-hover")},function(){e(this).removeClass("jfmfs-button-hover")});var s=function(){var t=window.innerHeight;var n=document.compatMode;if(n||!e.support.boxModel){t=n=="CSS1Compat"?document.documentElement.clientHeight:document.body.clientHeight}return t};var h=function(){var t=p.innerHeight(),n=p.scrollTop(),r=p.offset().top,i,s,o=0,l=false,c=e(".jfmfs-friend:not(.hide-filtered )");e.each(c,function(i,h){o++;if(h!==null){h=e(c[i]);s=f+a*Math.ceil(o/u)-n-r;if(s+a>=-10&&s-a<t){h.data("inview",true);h.trigger("inview",[true]);l=true}else{if(l){return false}}}})};var v=function(){e("#jfmfs-selected-count").html(w())};p.bind("scroll",e.debounce(250,h));S();h();v();r.trigger("jfmfs.friendload.finished")};var w=function(){return e(".jfmfs-friend.selected").length};var E=function(){return l.max_selected>0};var S=function(){var t=l.labels.max_selected_message.replace("{0}",w()).replace("{1}",l.max_selected);e("#jfmfs-max-selected-wrapper").html(t)}};e.fn.jfmfs=function(n){return this.each(function(){var r=e(this);if(r.data("jfmfs")){return}var i=new t(this,n);r.data("jfmfs",i)})};e.expr[":"].Contains=function(t,n,r){return e(t).text().toUpperCase().indexOf(r[3].toUpperCase())>=0}})(jQuery);if($.debounce===undefined){(function(e,t){var n=e.jQuery||e.Cowboy||(e.Cowboy={}),r;n.throttle=r=function(e,r,i,s){function a(){function p(){u=+(new Date);i.apply(n,l)}function v(){o=t}var n=this,a=+(new Date)-u,l=arguments;if(s&&!o){p()}o&&clearTimeout(o);if(s===t&&a>e){p()}else{if(r!==true){o=setTimeout(s?v:p,s===t?e-a:e)}}}var o,u=0;if(typeof r!=="boolean"){s=i;i=r;r=t}if(n.guid){a.guid=i.guid=i.guid||n.guid++}return a};n.debounce=function(e,n,i){return i===t?r(e,n,false):r(e,i,n!==false)}})(this)}
